<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Employees</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<!-- Bootstrap -->
		<link rel="stylesheet"
			href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
		<script
			src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
		<!-- jQuery -->
		<script
			src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
		<script
			src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
	</head>
	<body>
		<h2>Employees</h2>
		<form class="form-inline" action="/capstone/employees" method="get" id="my_form">
			<div class='form-group' style='margin-top: 50px;'>
				<label for="emp_id">Emp Id:</label> 
					<input type="text" class="form-control" name="id" id="emp_id" value="" placeholder="EMP-XXXX" style='width: 100px;'>
				<input type="submit" class="btn btn-primary" value="Find" id="get_btn">
			    <input type="reset" class="btn btn-secondary" id="reset_btn" value="Clear" />
			</div>
		</form>
		<div>
			<br/>
			<table class="table table-striped table-dark" id="table_id" ></table>
		</div>
	</body>
	<script>
	function removeEmployee(id){
		var r = confirm("Remove employee "+ id);
		if(r){
			$.ajax(
					{
						url : "/capstone/employees/"+id,
						type: "delete",
						data : {id:id}
					}
				)
				.done(function(response)
					{ //
						alert(response);
						$("#get_btn").click();
					}
				)
				.fail (function(jqxhr, textStatus, errorThrown) {
						alert("Error: " + jqxhr.statusText + " : " + jqxhr.responseText) ;
						$("#reset_btn").click();
					}
				);
		}
		else{
			alert("Cancelled removing employee")
		}
	}
	$("#my_form")
		.submit(function(event){
			event.preventDefault(); //prevent default action 
			var get_url = $(this).attr("action"); //get form action url
			var request_method = $(this).attr("method"); //get form GET/POST method
			var id=$("#emp_id").val();
			if(id!=""){
				var empRegex = new RegExp(/^EMP-\d{4}$/);
				if(id.match(empRegex)){
					get_url =get_url + "/"+ id;
				}
				else{
					alert("Employee Id format EMP-XXXX");
					return;
				}
			}
			$.ajax(
				{
					url : get_url,
					type: "get"
				}
			)
			.done(function(response)
				{ 
					var jsonObject = response;
					var strHtml = "<thead><tr><th scope='col'>Emp Id</th><th scope='col'>First Name</th><th scope='col'>Last Name</th><th scope='col'>Email</th><th scope='col'>Action</th></tr></thead>";
					strHtml += "<tbody>"
					$(jsonObject).each(function()
						{
							var row = $(this)[0];
							var empId = row["empId"];
							strHtml += '<tr>'+
										'<td>'+empId+'</td>'+
										'<td>'+row["firstName"]+'</td>'+
										'<td>'+row["lastName"]+'</td>'+
										'<td>'+row["email"]+'</td>'+
										'<td><button class=\'btn btn-warning\' onclick="removeEmployee(\''+empId+'\')">Remove</button></td>'+
									   '</tr>';
						}
					);
					strHtml += "</tbody>"
			 		$('#table_id').html(strHtml);
				}
			)
			.fail (function(jqxhr, textStatus, errorThrown)  
				{
					alert("Error: " + jqxhr.statusText + " : " + jqxhr.responseText) ;
				}
			);
		}
	);
	</script>
</html>